<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Chartist.JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
    <script src="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
    <!-- jQuery -->
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"></script>
    <!-- Oxygen Mono font -->
    <link href="https://fonts.googleapis.com/css2?family=Oxygen+Mono&display=swap" rel="stylesheet">
    <style>
      .color1 { color: #2D221C; }
      .color2 { color: #E20045; }      
      html, body { height: 100%; }
      html { display: table; margin: auto; }
      body {
          display: table-cell;
          vertical-align: middle;
          background-color: #E6E5E2; font-family: 'Oxygen Mono', monospace;
      }
      h1 {
          justify-content: center;
          text-align: center;
          font-size:6vw;
      }
      #content {
          padding-left: 10%;
          padding-right: 10%;
      }
      </style>
  </head>
  <body>
    <div id="content">
      <h1><span class="color1">CURVA</span> <span class="color2">COVID-19</span></h1>
      <div id="charts">
        <div>
          <h2><span class="color1">Infecciones</span> <span class="color2">(Absolutas)</span></h2>
          <div class="ct-chart" id="caseschart"></div>
        </div>
        <div>
          <h2><span class="color1">Muertes</span> <span class="color2">(Absolutas)</span></h2>
          <div class="ct-chart" id="deathschart"></div>
        </div>
        <div>
          <h2><span class="color1">Infecciones</span> <span class="color2">(Por Millón de Habitantes)</span></h2>
          <div class="ct-chart" id="casespermillionchart"></div>
        </div>
        <div>
          <h2><span class="color1">Muertes</span> <span class="color2">(Por Millón de Habitantes)</span></h2>
          <div class="ct-chart" id="deathspermillionchart"></div>
        </div>
      </div>
    </div>
  </body>
  <script type="text/javascript">
    function plot(data, name){
        var series = data.map(function(country) {
            return country.data.map(function(record) { return record.value });
        });

        var labels = data.map(function(country) { return country.name });
        
        new Chartist.Line("#" + name, {
            series: series
        }, {
            fullWidth: true,
            chartPadding: {
                right: 40
            }
            //,
            //plugins: [
            //    Chartist.plugins.legend({
            //        legendNames: labels
            //    })
            //]
        });
    }

    function drop_until(data, func, drop = true, acc = []) {
        if(data && data.length) {
            var record = data.pop();
            
            if(drop) {
                // Still waiting for 'until condition'
                if(func(record)) {
                    // Add current element to the accumulator and set drop to false
                    acc.push(record);
                    return drop_until(data, func, false, acc);
                } else {
                    return drop_until(data, func, true, acc);
                }
            } else {
                acc.push(record);
                return drop_until(data, func, drop, acc);
            }
        } else {
            return acc;
        }
    }
    
    $(document).ready(function(e) {
        $.getJSON( "data/covid19.json")
            .done(function(data){
//                $.getScript( "https://raw.githubusercontent.com/CodeYellowBV/chartist-plugin-legend/4e86f4352b0a3041f3a36c487499b1bec1108e56/chartist-plugin-legend.js", function(script, status, jqxhr ) {
                    var allRecords = data.records;

                    var countries = [
                        {
                            "name": "España",
                            "code": "ES"
                        },
                        {
                            "name": "Italia",
                            "code": "IT"
                        }
                    ];

                    var preparedData = countries.map(function(country) {
                        var rawCountryData =  allRecords.filter(function(record) {return record.geoId === country.code} )
                        var preparedCountryData = rawCountryData
                            .map(function(record) {
                                return {
                                    "date": record.dateRep,
                                    "cases": record.cases,
                                    "casesPerMillion": (record.cases / record.popData2018) * 1000000,
                                    "deaths": record.deaths,
                                    "deathsPerMillion": (record.deaths / record.popData2018) * 1000000,
                                    "population": record.popData2018
                                }
                            });
                        var data = drop_until(preparedCountryData, function(record) { return record.cases >= 500 });
                        var countryData = {
                            "name": country.name,
                            "code": country.code,
                            "data": data
                        };
                        return countryData
                    });

                    var cases = preparedData.map(function(country) {
                        var data = country.data.map(function(record) {
                            return {
                                "date": record.date,
                                "value": record.cases,
                            }
                        });
                        return {
                            "name": country.name,
                            "code": country.code,
                            "data": data
                        }
                    });

                    var deaths = preparedData.map(function(country) {
                        var data = country.data.map(function(record) {
                            return {
                                "date": record.date,
                                "value": record.deaths,
                            }
                        });
                        return {
                            "name": country.name,
                            "code": country.code,
                            "data": data
                        }
                    });

                    var casesPerMillion = preparedData.map(function(country) {
                        var data = country.data.map(function(record) {
                            return {
                                "date": record.date,
                                "value": record.casesPerMillion
                            }
                        });
                        return {
                            "name": country.name,
                            "code": country.code,
                            "data": data
                        }
                    });

                    var deathsPerMillion = preparedData.map(function(country) {
                        var data = country.data.map(function(record) {
                            return {
                                "date": record.date,
                                "value": record.deathsPerMillion
                            }
                        });
                        return {
                            "name": country.name,
                            "code": country.code,
                            "data": data
                        }
                    });

                    plot(cases, "caseschart");
                    plot(deaths, "deathschart");
                    plot(casesPerMillion, "casespermillionchart");
                    plot(deathsPerMillion, "deathspermillionchart");                      
                } );
//            } );
    });
  </script>
</html>
